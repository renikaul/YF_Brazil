---
title: "Variable Selection and Univariate Analysis"
author: "Michelle Evans"
date: "June 1, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(tidyverse)
library(corrplot)
library(PerformanceAnalytics)
library(Hmisc)
```

This document explores collinearity between covariates and then uses a univariate analysis of each to provide support for variable selection.

# Load Covariates

1. load cleaned data that Reni made in giantdfmaker (training only)
2. load extra covariates for temp and rainfall
3. subset to match training data
4. transform as necessary (temp: none, rf: cube root transformed (`TranCube`))

```{r}
#cleaned data
train.data <- readRDS("../data_clean/FinalData_Mosi/TrainingData.rds")

# extra environmental covariates
rf <- readRDS("../data_clean/environmental/may2018/allRainfall.rds")
temper <- readRDS("../data_clean/environmental/may2018/allTemperature.rds")
```

Function to transform data.

```{r}
TranCube = function(x) {sign(x) * abs(x)^(1/3)}
```


Join to cleaned data

```{r}
all.data <- train.data %>%
  left_join(temper, by = c("muni.no", "month.no")) %>%
  left_join(rf, by = c("muni.no", "month.no")) %>%
  #transform rf
  mutate(rf.min = TranCube(hourlyRainfallMin)) %>%
  mutate(rf.max = TranCube(hourlyRainfallMax)) %>%
  dplyr::select(-numCase, -year.x, -cal.month.x, -muni.name, -year.y, -cal.month.y, 
                -tempMean, -year, -cal.month, -hourlyRainfallMin, -hourlyRainfallMax, -hourlyRainfallMean)
```

# Collinearity


```{r}
env.vars <- dplyr::select(all.data, -muni.no, -month.no, -case)
cor.mat <- cor(env.vars)

cor.obj <- rcorr(as.matrix(env.vars), type = "pearson")
cor.mat <- cor.obj$r
p.mat <- cor.obj$P
```

Plot it (following styling from this [blog](https://rstudio-pubs-static.s3.amazonaws.com/240657_5157ff98e8204c358b2118fa69162e18.html):

```{r}
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
```


```{r}

tiff(file = "../data_out/MS_results_revisions/figures/correlationMatrix.tiff", width = 1500, height = 1500, units = "px", res = 300, family = "sans", compression = "lzw")

corrplot(cor.mat, method = "color", col = col(200),  
         type = "upper", order = "hclust", 
         addCoef.col = "black", # Add coefficient of correlation
         tl.col = "black", tl.srt = 45, #Text label color and rotation
         # hide correlation coefficient on the principal diagonal
         diag = FALSE, tl.cex = 0.5, number.cex = 0.5
         )

dev.off()
```

# Univariate Analyses

There are some variables that have an over 0.9 correlation with each other. We created univariate logistic regressions on the whole dataset to see which are more explanatory. Note our actual model is a bagged logistic regression, so a single logistic regression may have different results

For this, we will use AIC with a \deltaAIC > 10 denoting a difference amongst models.

## Temperature

min, mean, and max temp were highly correlated with pearson's \rho values between 0.89 and 0.97.

```{r}
#create models
tmean.mod <- glm(case ~ temp, data = all.data, family = binomial (link = "logit"))
tmin.mod <- glm(case ~ tempMin, data = all.data, family = binomial (link = "logit"))
tmax.mod <- glm(case ~ tempMax, data = all.data, family = binomial (link = "logit"))

#compare AIC
AIC(tmean.mod, tmin.mod, tmax.mod)
```

## Rainfall

Min, mean, max rf were all highly correlated with pearson's coefficients between 0.97 and 0.99.

```{r}
#create models
rf.mean.mod <- glm(case ~ rf, data = all.data, family = binomial (link = "logit"))
rf.min.mod <- glm(case ~ rf.min, data = all.data, family = binomial (link = "logit"))
rf.max.mod <- glm(case ~ rf.max, data = all.data, family = binomial (link = "logit"))

#compare AIC
AIC(rf.mean.mod, rf.min.mod, rf.max.mod)
```


---
title: "TwoModelVariableSelection"
output: 
  html_document: 
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
```


```{r load packages}
#load packages
library(dplyr)
library(gplots)
library(parallel)
library(doParallel)
library(ROCR)
library(pROC)

#source functions
source("functions/baggingWperm.R")

#Return AUC Quick
RankImp=function(x){
PermSFAUC <- x[[2]]
PermSFAUC[,2] <- round(as.numeric(as.character(PermSFAUC[,2])),digits=3)
PermSFAUC[,3] <- round(as.numeric(as.character(PermSFAUC[,3])),digits=3)
return(PermSFAUC[order(PermSFAUC$meanAUC),])}

#load data
## High NHP
Htraining.data <- readRDS("../data_clean/TrainingDataHighNHP.rds")
## Low NHP
Ltraining.data <- readRDS("../data_clean/TrainingDataLowNHP.rds")
```

# Full Model



```{r Kitchen sink}
glm.formula <- as.formula("case~  NDVI+NDVIScale+
                          popLog10+
                          RF+RFsqrt+RFScale+
                          tempMean+tempScale+
                          fireDenSqrt+fireDenScale+
                          spRich+primProp") 

## High NHP
#load data
Htraining.data <- readRDS("../data_clean/TrainingDataHighNHP.rds")
HPermFullModel <- permOneVar(formula = glm.formula,traindata = Htraining.data, cores = 10, no.iterations = 500, perm = 10, viz = TRUE, title="High NHP Full Model")
saveRDS(HPermFullModel, "../data_out/TwoModelSoln/HPermFullModel.rds")

## Low NHP
#load data
Ltraining.data <- readRDS("../data_clean/TrainingDataLowNHP.rds")
LPermFullModel <- permOneVar(formula = glm.formula,traindata = Ltraining.data, cores = 10, no.iterations = 500, perm = 10, viz = TRUE, title="Low NHP Full Model")
saveRDS(LPermFullModel, "../data_out/TwoModelSoln/LPermFullModel.rds")
```

```{r kitchen sink predictions}

hPredFull <-  BaggedModel(form.x.y = glm.formula, training = Htraining.data, new.data = Htraining.data, no.iterations = 500)
lPredFull <-  BaggedModel(form.x.y = glm.formula, training = Ltraining.data, new.data = Ltraining.data, no.iterations = 500)

save(hPredFull,lPredFull, file = "../data_out/Predictions/TwoModel/fullPredictions.RData")


```

# Popless 
```{r drop Pop}
#drop one covar importance
glm.formula.popless <- as.formula("case~  NDVI+NDVIScale+ 
                          RFsqrt+RFScale+
                          tempMean+tempScale+
                          fireDenSqrt+fireDenScale+
                          spRich+primProp") 

PoplessVariables <- trimws(unlist(strsplit(as.character(glm.formula.popless)[3], "+", fixed = T)), which = "both")

#High NHP
HPermPoplessModel <- permOneVar(formula = glm.formula.popless,traindata = Htraining.data, cores=10, no.iterations = 500, perm = 10,viz=TRUE, title="High NHP, Popless" ) 
saveRDS(HPermPoplessModel, "../data_out/TwoModelSoln/HPermPoplessModel.rds")


#Low NHP

Sys.time()
LPermPoplessModel <- permOneVar(formula = glm.formula.popless,traindata = Ltraining.data, cores=10, no.iterations = 500, perm = 10 ,viz=TRUE, title="Low NHP, Popless")
Sys.time()
saveRDS(LPermPoplessModel, "../data_out/TwoModelSoln/LPermPoplessModel.rds")


```

```{r popless predictions}


hPredPopless <-  BaggedModel(form.x.y = glm.formula.popless, training = Htraining.data, new.data = Htraining.data, no.iterations = 500)
lPredPopless <-  BaggedModel(form.x.y = glm.formula.popless, training = Ltraining.data, new.data = Ltraining.data, no.iterations = 500)

save(hPredPopless,lPredPopless, file = "../data_out/Predictions/TwoModel/poplessPredictions.RData")

```

***

# Removing 2014 data

The 2014 data is missing primate proportion (primProp : sum of each municipalities relative area that is both agricultural and falls within a primate genus range. {0,9}). This wasn't an issue when were exploring a single flavor approach to the model, but in the two point process approach different covariates are important so we've decided to not do any variable selection. Since glms only work on complete cases, this means that we have to drop 2014 data (1 case). 

```{r trimming the training data}
hTrimTrain <-  Htraining.data %>%
                filter(year <2014)


lTrimTrain <-  Ltraining.data %>%
                filter(year <2014)

```

## Kitchen Sink

```{r trimmed Kitchen sink }
glm.formula <- as.formula("case~  NDVI+NDVIScale+
                          popLog10+
                          RF+RFsqrt+RFScale+
                          tempMean+tempScale+
                          fireDenSqrt+fireDenScale+
                          spRich+primProp") 

## High NHP
#load data
hPermFull <- permOneVar(formula = glm.formula, bag.fnc = baggingTryCatch, traindata = hTrimTrain, cores = 10, no.iterations = 50, perm = 10, viz = TRUE, title="High NHP Full Model")

hsaveRDS(hPermFull, "../data_out/TwoModelSoln/Trim2014/HPermFullModelTryCatch.rds")

## Low NHP
#load data
lPermFull <- permOneVar(formula = glm.formula,traindata = lTrimTrain, cores = 10, no.iterations = 500, perm = 10, viz = TRUE, title="Low NHP Full Model")
saveRDS(lPermFull, "../data_out/TwoModelSoln/Trim2014/LPermFullModel.rds")
```

```{r trimmed kitchen sink predictions}

hPredFull <-  BaggedModel(form.x.y = glm.formula, training = hTrimTrain, new.data = hTrimTrain, no.iterations = 500)
lPredFull <-  BaggedModel(form.x.y = glm.formula, training = lTrimTrain, new.data = lTrimTrain, no.iterations = 500)

save(hPredFull,lPredFull, file = "../data_out/Predictions/TwoModel/Trim2014/fullPredictions.RData")
```


# Popless 
```{r trimmed drop Pop}
#drop one covar importance
glm.formula.popless <- as.formula("case~  NDVI+NDVIScale+ 
                          RFsqrt+RFScale+
                          tempMean+tempScale+
                          fireDenSqrt+fireDenScale+
                          spRich+primProp") 

#High NHP
hPermPoplessModel <- permOneVar(formula = glm.formula.popless,traindata = hTrimTrain, cores=10, no.iterations = 500, perm = 10,viz=TRUE, title="High NHP, Popless" ) 
saveRDS(hPermPoplessModel, "../data_out/TwoModelSoln/Trim2014/HPermPoplessModel.rds")


#Low NHP
lPermPoplessModel <- permOneVar(formula = glm.formula.popless,traindata = lTrimTrain, cores=10, no.iterations = 500, perm = 10 ,viz=TRUE, title="Low NHP, Popless")
saveRDS(lPermPoplessModel, "../data_out/TwoModelSoln/Trim2014/LPermPoplessModel.rds")


```

```{r trimmed popless predictions}


hPredPopless <-  BaggedModel(form.x.y = glm.formula.popless, training = hTrimTrain, new.data = hTrimTrain, no.iterations = 500)
lPredPopless <-  BaggedModel(form.x.y = glm.formula.popless, training = lTrimTrain, new.data = lTrimTrain, no.iterations = 500)

save(hPredPopless,lPredPopless, file = "../data_out/Predictions/TwoModel/Trim2014/poplessPredictions.RData")

```


***

# Removing perfect sep models

Some bags were returning the warning of perfect seperation. The `bagging` function was modified with `tryCatch` to toss any models with this warning message. 

## Kitchen Sink

```{r trimmed tryCatch Kitchen sink }
glm.formula <- as.formula("case~  NDVI+NDVIScale+
                          popLog10+
                          RF+RFsqrt+RFScale+
                          tempMean+tempScale+
                          fireDenSqrt+fireDenScale+
                          spRich+primProp") 

## High NHP
#load data
hPermFull <- permOneVar(formula = glm.formula, bag.fnc = baggingTryCatch, traindata = hTrimTrain, cores = 10, no.iterations = 500, perm = 10, viz = TRUE, title="High NHP Full Model")

saveRDS(hPermFull, "../data_out/TwoModelSoln/Trim2014/HPermFullModelTryCatch.rds")

## Low NHP
#load data
lPermFull <- permOneVar(formula = glm.formula, bag.fnc = baggingTryCatch,traindata = lTrimTrain, cores = 10, no.iterations = 500, perm = 10, viz = TRUE, title="Low NHP Full Model")
saveRDS(lPermFull, "../data_out/TwoModelSoln/Trim2014/LPermFullModelTryCatch.rds")
```

```{r trimmed tryCatch kitchen sink predictions}

hPredFull <-  BaggedModel(form.x.y = glm.formula,bag.fnc = baggingTryCatch, training = hTrimTrain, new.data = hTrimTrain, no.iterations = 500)
lPredFull <-  BaggedModel(form.x.y = glm.formula, bag.fnc = baggingTryCatch,training = lTrimTrain, new.data = lTrimTrain, no.iterations = 500)

save(hPredFull,lPredFull, file = "../data_out/Predictions/TwoModel/Trim2014/fullPredictionsTryCatch.RData")
```


# Popless 
```{r trimmed tryCatch drop Pop}
#drop one covar importance
glm.formula.popless <- as.formula("case~  NDVI+NDVIScale+ 
                          RFsqrt+RFScale+
                          tempMean+tempScale+
                          fireDenSqrt+fireDenScale+
                          spRich+primProp") 

#High NHP
hPermPoplessModel <- permOneVar(formula = glm.formula.popless,bag.fnc = baggingTryCatch,traindata = hTrimTrain, cores=10, no.iterations = 500, perm = 10,viz=TRUE, title="High NHP, Popless" ) 
saveRDS(hPermPoplessModel, "../data_out/TwoModelSoln/Trim2014/HPermPoplessModelTryCatch.rds")


#Low NHP
lPermPoplessModel <- permOneVar(formula = glm.formula.popless,bag.fnc = baggingTryCatch,traindata = lTrimTrain, cores=10, no.iterations = 500, perm = 10 ,viz=TRUE, title="Low NHP, Popless")
saveRDS(lPermPoplessModel, "../data_out/TwoModelSoln/Trim2014/LPermPoplessModelTryCatch.rds")


```

```{r trimmed tryCatch popless predictions}


hPredPopless <-  BaggedModel(form.x.y = glm.formula.popless,bag.fnc = baggingTryCatch, training = hTrimTrain, new.data = hTrimTrain, no.iterations = 500)
lPredPopless <-  BaggedModel(form.x.y = glm.formula.popless, bag.fnc = baggingTryCatch,training = lTrimTrain, new.data = lTrimTrain, no.iterations = 500)

save(hPredPopless,lPredPopless, file = "../data_out/Predictions/TwoModel/Trim2014/poplessPredictionsTryCatch.RData")

```
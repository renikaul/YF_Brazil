---
title: "Map Predictions"
author: "Michelle Evans"
date: ""
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(rgdal)
library(viridis)
library(lubridate)
library(raster)
library(stringr)
library(dplyr)
library(gganimate)
library(sf)
```

This document creates a gif of the predictions from the bagging model.

# Load data

```{r load data}
brazFortified <- st_read("../data_clean", "BRAZpolygons")
brazFortified <- rename(brazFortified, muni.no = muni_no)

#get brazil outline
brazOutline <- getData('GADM', country ='BRA', level = 0)
outlineFortify <- st_as_sf(brazOutline)
outlineFortify <- select(outlineFortify, id = OBJECTID, ID_0, ISO)
#clean memory
rm(brazOutline)
```

#Mapping Theme

```{r create map theme}
theme_map <- function(...) {
  theme_minimal() +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    # panel.grid.minor = element_line(color = "#ebebe5", size = 0.2),
    # panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "#f5f5f2", color = NA), 
    panel.background = element_rect(fill = "#f5f5f2", color = NA), 
    legend.background = element_rect(fill = "#f5f5f2", color = NA),
    panel.border = element_blank(),
    ...
  )
}

```

# Plot Using ImageMagick Directly

```{r create plotting function, eval = F}
plotFunction <- function(monthIteration){
  #set title
  mapTitle <- paste("Model predictions for", month(monthIteration %% 12, label = T), (2001 + monthIteration %/% 12), sep = " ")
  
  #subset data
  subset2plot <- as.data.frame(predictions[predictions[,2]==monthIteration,])

  # now we join the thematic data
  map_data <- brazFortified %>% 
  left_join(subset2plot, by = "muni.no")
  
  #get single symbol for each case
  case_data <- map_data %>%
    filter(case==1) %>%
    filter(!is.na(lat)) %>%
    group_by(muni.no) %>%
    #get centroid
    summarise(long=mean(long, na.rm = T), lat = mean(lat, na.rm = T))
  
  p <-ggplot() +
    # municipality polygons
    geom_polygon(data = map_data, aes(fill = prediction, 
                                        x = long, 
                                        y = lat, 
                                        group = group)) +
    # add outline of all of brazil
    geom_path(data = outlineFortify, aes(x = long, 
                                   y = lat, 
                                   group = group), 
              color = "gray25", size = 0.1) +
    # add shape for cases
    geom_point(data = case_data, 
               aes(x = long, y = lat), 
               shape = 23, size = 2, fill = "green", col = "black") +
    coord_equal() +
    scale_color_manual(values = caseColor) +
    scale_fill_viridis(option = "magma", direction = -1, discrete = F,
                       na.value = "gray90", 
                       guide = guide_colorbar(
                                direction = "horizontal",
                                barheight = unit(2, units = "mm"),
                                barwidth = unit(50, units = "mm"),
                                draw.ulim = F,
                                title.position = 'top',
                                # some shifting around
                                title.hjust = 0.5,
                                label.hjust = 0.5),
                       limits = c(0,1)) +
    # add the previously defined basic theme
    theme_map() +
    guides(color = F) +
    labs(x = NULL, 
         y = NULL, 
       #  title = mapTitle, 
         subtitle = "True positive cases are noted by green diamonds.") +
    theme(legend.position = "bottom")
  
  return(p)  
  #dev.off()
}
```

```{r, eval = F}
Sys.time()
for (i in 1:168){
  #wrap in try catch because of image device failings
  tryCatch({
  png(paste0("figures/GIFplots/month", str_pad(i, 3, pad = "0"), ".png"), res = 400, 
      width = 5, height = 5, units = "in")
  p <- plotFunction(monthIteration = i)
  print(p)
  dev.off()
  })
}
Sys.time()
```
You will then need to use image Magick to combine into one giant gif. One day I will figure out how to call bash from R and then make it run from here.

cd into `figures/GIFplots`
CMDLINE: `convert -delay 100 *.png \ predictionsAll.gif`

# Plot w/ gganimate

Try it using `gganimate`. This runs faster, but makes lower quality plots (resolution wise).

## One Model
Create the plot. Remember to use a machine with >8 gb RAM.

```{r}
#one model
predOneModel <- readRDS("../data_out/Predictions/SpaceAndTime/Trim2014/fullPredictions.rds")
```

```{r create dataframe to plot, eval = F}
preds <- as.data.frame(predOneModel)

#create month levels so they plot in order
month_levels <- paste(month(1:12, label = T), rep(2001:2014, each =12), sep = " ")

 # now we join the prediction data
map_data <- brazFortified %>% 
  left_join(preds, by = c("muni.no")) %>%
  filter(!is.na(month.no)) %>%
  arrange(month.no) %>%
  #create title/frame for gganimate
  mutate(mapTitle = factor(paste(month(month.no %% 12, label = T), 
                                 (2001 + month.no %/% 12), 
                                 sep = " "), 
                           levels = month_levels))
  
# only need to do this once as map outline is the same
monthOutline <- data.frame(mapTitle = unique(map_data$mapTitle),
                           id = "1")
  #join outline data too
  outlineFortifyAnimate <- outlineFortify %>%
    left_join(monthOutline, by = "id")
```


```{r create plot, eval = F}
  p <- ggplot(data = map_data, 
              aes(frame = mapTitle)
              ) +
    # municipality polygons
    geom_polygon(data = map_data, aes(fill = prediction, 
                                      x = long, 
                                      y = lat, 
                                      group = group)) +
    # add outline of all of brazil
    geom_path(data = outlineFortifyAnimate, aes(x = long,
                                   y = lat,
                                   group = group),
              color = "gray25", size = 0.1) +
    # add shape for cases
    geom_point(data = map_data[map_data$case==1,], 
               aes(x = long, y = lat), 
               shape = 23, size = 1, col = "green") +
    coord_equal() +
    scale_color_manual(values = caseColor) +
    scale_fill_viridis(option = "magma", direction = -1, discrete = F,
                       na.value = "gray70", 
                       guide = guide_colorbar(
                                direction = "horizontal",
                                barheight = unit(2, units = "mm"),
                                barwidth = unit(50, units = "mm"),
                                draw.ulim = F,
                                title.position = 'top',
                                # some shifting around
                                title.hjust = 0.5,
                                label.hjust = 0.5),
                       limits = c(0,1)) +
    # add the previously defined basic theme
    theme_map() +
    guides(color = F) +
    labs(x = NULL, 
         y = NULL, 
         #title = mapTitle, 
         subtitle = "True positive cases are noted by green diamonds.") +
    ggtitle("Model predictions for ") +
    theme(legend.position = "bottom")
```

Animate and save.
```{r, eval = F}
gganimate(p, interval = 1.5, "figures/mapPredsOneModel.gif")
```

## Two Model

Note that I drop the data from one model here becuase it takes up too much RAM.

```{r load two model data}
rm(preds, predOneModel, map_data)
#two model
predTwoModel <- load("../data_out/Predictions/TwoModel/Trim2014/fullPredictions.RData")
predHighNHP <- hPredFull
predLowNHP <- lPredFull

rm(lPredFull, hPredFull, predTwoModel)

```


Create the plots. Same as above, watch memory usage.

### High NHP

```{r}
preds <- as.data.frame(predHighNHP)

#create month levels so they plot in order
month_levels <- paste(month(1:12, label = T), rep(2001:2014, each =12), sep = " ")

 # now we join the prediction data
map_data <- brazFortified %>% 
  left_join(preds, by = c("muni.no")) %>%
  filter(!is.na(month.no)) %>%
  arrange(month.no) %>%
  #create title/frame for gganimate
  mutate(mapTitle = case_when(
    month.no%%12 == 0 ~ factor(paste(month(12, label = T), 
                                 (2001 + month.no %/% 12), sep = " "), 
                           levels = month_levels),
      TRUE            ~ factor(paste(month(month.no %% 12, label = T), 
                                 (2001 + month.no %/% 12), sep = " "), 
                           levels = month_levels))
  )
  
monthOutline <- data.frame(mapTitle = unique(map_data$mapTitle), id = 1)
#join outline data too
outlineFortifyAnimate <- outlineFortify %>%
    left_join(monthOutline, by = "id")

#calculate positives to plot
positives <- st_centroid(filter(map_data, case >0))
```

```{r}
p <- ggplot() +
  # add outline of all of brazil
  geom_sf(data = outlineFortifyAnimate, aes(frame = mapTitle),
          color = "gray25", size = 0.1) +
  # municipality polygons
  geom_sf(data = map_data, aes(fill = prediction, frame = mapTitle), color = NA) +
  # add shape for cases
  geom_sf(data = positives,
          shape = 23, size = 1, col = "green", aes(frame = mapTitle)) +
  coord_sf() +
  scale_fill_viridis(option = "magma", direction = -1, discrete = F,
                     na.value = "gray70", 
                     guide = guide_colorbar(
                       direction = "horizontal",
                       barheight = unit(2, units = "mm"),
                       barwidth = unit(50, units = "mm"),
                       draw.ulim = F,
                       title.position = 'top',
                       # some shifting around
                       title.hjust = 0.5,
                       label.hjust = 0.5),
                     limits = c(0,1)) +
  # add the previously defined basic theme
  theme_map() +
  guides(color = F) +
  labs(x = NULL, 
       y = NULL) +
  ggtitle("High NHP model predictions for ") +
  theme(legend.position = "bottom")
```

Animate and save.
```{r}
gganimate(p, interval = 1.5, "figures/mapPredsHighNHP.gif")
```

### Low NHP

```{r}
rm(preds, map_data)
```

```{r}
preds <- as.data.frame(predLowNHP)

#create month levels so they plot in order
month_levels <- paste(month(1:12, label = T), rep(2001:2014, each =12), sep = " ")

 # now we join the prediction data
map_data <- brazFortified %>% 
  left_join(preds, by = c("muni.no")) %>%
  filter(!is.na(month.no)) %>%
  arrange(month.no) %>%
  #create title/frame for gganimate
  mutate(mapTitle = case_when(
    month.no%%12 == 0 ~ factor(paste(month(12, label = T), 
                                 (2001 + month.no %/% 12), sep = " "), 
                           levels = month_levels),
      TRUE            ~ factor(paste(month(month.no %% 12, label = T), 
                                 (2001 + month.no %/% 12), sep = " "), 
                           levels = month_levels))
  )
  
monthOutline <- data.frame(mapTitle = unique(map_data$mapTitle), id = 1)
#join outline data too
outlineFortifyAnimate <- outlineFortify %>%
    left_join(monthOutline, by = "id")

#calculate positives to plot
positives <- st_centroid(filter(map_data, case >0))
```

```{r}
p <- ggplot() +
  # add outline of all of brazil
  geom_sf(data = outlineFortifyAnimate, aes(frame = mapTitle),
          color = "gray25", size = 0.1) +
  # municipality polygons
  geom_sf(data = map_data, aes(fill = prediction, frame = mapTitle), color = NA) +
  # add shape for cases
  geom_sf(data = positives,
          shape = 23, size = 3, col = "green", aes(frame = mapTitle)) +
  coord_sf() +
  scale_fill_viridis(option = "magma", direction = -1, discrete = F,
                     na.value = "gray70", 
                     guide = guide_colorbar(
                       direction = "horizontal",
                       barheight = unit(2, units = "mm"),
                       barwidth = unit(50, units = "mm"),
                       draw.ulim = F,
                       title.position = 'top',
                       # some shifting around
                       title.hjust = 0.5,
                       label.hjust = 0.5),
                     limits = c(0,1)) +
  # add the previously defined basic theme
  theme_map() +
  guides(color = F) +
  labs(x = NULL, 
       y = NULL) +
  ggtitle("Low NHP model predictions for ") +
  theme(legend.position = "bottom")
```

Animate and save.
```{r}
gganimate(p, interval = 1.5, "figures/mapPredsLowNHP.gif")
```
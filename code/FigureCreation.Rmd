---
title: "Manuscript Figures"
author: ""
date: "January 23, 2018"
output: html_document
---

# Packages and Set-Up

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)

#fig 1
library(reshape2)

#fig 3
library(sf)
library(raster)
library(ggplot2)
library(viridis)
library(RColorBrewer)

#fig 4
library(sf)
library(raster)
library(viridis)
library(cowplot)
library(ggthemes)
library(lubridate)
library(dplyr)
library(ggplot2)
```

This document creates the figures for:

*Insert manuscript citation here*

I'm currently loading data individually for each figure, then if you want to remake one figure you don't have to rerun the whole document, just that section.
#Figure 1: Relative Variable Importance as quantiles

The median, and 95% quantile reported for dAUC scaled to max median dAUC for each model. 

```{r relative variable importance Quantile}
#function to calculate dAUC stats
RelativeImportance=function(x, model="NA"){
  perms <- x[[3]][complete.cases(x[[3]]),-c(1, dim(x[[3]])[2])] # pull out AUC values, but drop full model and all permuted data columns 
  model.AUC <- as.numeric(as.character(x[[2]][1,2])) # pull out AUC for full model
  # calculate delta AUC
  delta.AUC <- model.AUC- perms
    # scale delta AUC between zero and one
    #scale.delta.AUC <- delta.AUC/max(delta.AUC)
  #calculate median, upper and lower quantiles
  Quant.dAUC <- delta.AUC %>% 
    melt(value.name="dAUC") %>% 
    rename(Rep=Var1, Variable=Var2)%>% 
    group_by(Variable) %>%
    summarise(dAUCmean=mean(dAUC),dAUCmedian=median(dAUC),Q975=quantile(dAUC, probs=0.975),Q025=quantile(dAUC, probs=0.025) ) %>%
    ungroup()
  
  scale.dAUC <- Quant.dAUC %>%
      group_by(Variable) %>%
      mutate_all(funs(./max(Quant.dAUC$Q975))) %>% # divid all values by max median value
      arrange(desc(dAUCmedian))%>%
      ungroup() %>%  
      mutate(Rank=c(11:1), Model=model)
      
  return(scale.dAUC)
}

#variable names for publication
niceNames <- c("popLog10"="Population",
               "spRich" = "NHP Richness",
               "RFsqrt" = "Mean Rainfall",
               "tempMean" = "Mean Temperature",
               "NDVIScale" = "Scaled NDVI",
               "tempScale" = "Scaled Mean Temperature",
               "primProp" = "NHP Agriculture Overlap",
               "RFScale" = "Scaled Mean Rainfall",
               "fireDenScale" = "Scaled Fire Density",
               "NDVI" ="NDVI",
               "fireDenSqrt" ="Fire Density")

#load data
fullM <- readRDS("../data_out/MS_results/OneModel/Perm100FullModel500TryCatch.rds") 
lowM <- readRDS("../data_out/MS_results/LowModel/lPerm100Model500TryCatch.rds")
highM <- readRDS('../data_out/MS_results/HighModel/HPerm100Model500TryCatch.rds')

#calculate dAUC stats
hri <- RelativeImportance(highM, "High")
lri <- RelativeImportance(lowM, "Low")
fri <- RelativeImportance(fullM, "Single")
allRelImportance<- rbind(fri,lri,hri)

#reorder factors for plotting 
allRelImportance <- within(allRelImportance, Variable <- factor(Variable, levels = c( "popLog10","spRich","RFsqrt","tempMean","NDVIScale","tempScale","primProp","RFScale","fireDenSqrt","NDVI","fireDenScale")))
allRelImportance <- within(allRelImportance, Model <- factor(Model, levels = c("Single","Low","High")))

  
b2  <-  ggplot(allRelImportance, aes(x=Variable, y=dAUCmedian, ymin = Q025, ymax = Q975, fill=Model))+
    geom_hline(yintercept = 0.0, color="grey50", linetype=2) +
    geom_crossbar(position="dodge")+
    #scale_y_continuous(limits=c(-.5,2))+
    #geom_point(y=allRelImportance$dAUCmean)+
    ylab("Relative Importance") + xlab("variable") +
    scale_x_discrete("",labels=niceNames) +
    theme_few()+
    theme(axis.text.x=element_text(angle=35, hjust=1), legend.position = c(.8,.8) ) +
    scale_fill_tableau("colorblind10")
  
  tiff("figures/manuscript/VarImpQuantiles.tiff")
  plot(b2)
  dev.off()
  
 # ggplot(allRelImportance, aes(x=Variable, y=dAUCmedian, ymin = Q025, ymax = Q975, fill=Model))+
 #    geom_crossbar()+
 #    facet_grid(Model~.)+
 #    scale_y_continuous(limits=c(-.05,1))+
 #    #geom_point(y=allRelImportance$dAUCmean)+
 #    geom_hline(yintercept = 0.0, color="grey50", linetype=2) +
 #    ylab("Relative Importance") + xlab("variable") +
 #    scale_x_discrete("",labels=niceNames) +
 #    theme_few()+
 #    theme(axis.text.x=element_text(angle=35, hjust=1), legend.position = c(.9,.9) ) +
 #    scale_fill_tableau("colorblind10")
 #  
 #  tiff("figures/manuscript/VarImpQuantilesLattice.tiff")
 #  plot(b2)
 #  dev.off()
  
b3 <-  ggplot(allRelImportance, aes(x=Variable, y=dAUCmedian, fill=Model)) + 
  geom_bar(stat="identity",position="dodge")+
  #geom_errorbar(position="dodge", colour="black")+
  ylab("Relative Importance") + xlab("variable") +
   #scale_y_continuous(expand = c(0, 0)) +
   scale_x_discrete("",labels=niceNames) +
  theme_few()+
  theme(axis.text.x=element_text(angle=35, hjust=1), legend.position = c(.8,.8) ) +
  scale_fill_tableau("colorblind10")

tiff("figures/manuscript/VarImpMedian.tiff")
plot(b3)
dev.off()
```

# Figure 1: Variable Importance (OLD)

Dodged barplot of variable importance, calculated by random pairing of permutations and where error assumes a normal distribution. 

```{r, eval=FALSE}
#1. functions 

#Return Variable importance with stdev
VarImp =function(x){
  matrix.Of.AUCs <- x[[3]]
  var.Imp.AUCs <- matrix.Of.AUCs[complete.cases(matrix.Of.AUCs),-dim(matrix.Of.AUCs)[2]] #drop the all permutated, and rows with NAs (TryCatch failed)
  delta.AUC <- apply(var.Imp.AUCs,1,function(x) {(x[1]-x)/max(x[1]-x)} ) #calculate delta AUC and rescale to max delta AUC 
  #rel.import <- delta.auc/max(delta.auc, na.rm = TRUE) # normalized relative change in AUC from base model only for single variable permutation
  mean.Delta.AUC <- apply(delta.AUC, 1, mean) #mean
  sem.Delta.AUC <- apply(delta.AUC,1,function(x) {sd(x)/sqrt(length(x))}) #standard error of the mean
  summary.Delta.AUC <- as.data.frame(cbind(mean.Delta.AUC, sem.Delta.AUC))#put them together
  summary.Delta.AUC$lci95.Delta.AUC <- apply(summary.Delta.AUC, 1, function(x) x[1]-2*x[2]) #lower 95% CI
  summary.Delta.AUC$uci95.Delta.AUC <- apply(summary.Delta.AUC, 1, function(x) x[1]+2*x[2]) #upper 95% CI
  summary.Delta.AUC$Variable <- rownames(summary.Delta.AUC)
  return(summary.Delta.AUC)
}

#2. Load data
fullM <- readRDS("../data_out/MS_results/OneModel/Perm100FullModel500TryCatch.rds") 
lowM <- readRDS("../data_out/MS_results/LowModel/lPerm100Model500TryCatch.rds")
highM <- readRDS('../data_out/MS_results/HighModel/HPerm100Model500TryCatch.rds')


Full <- VarImp(fullM)
HFull <- VarImp(highM)
LFull <- VarImp(lowM)

RankFull <- rbind(Full[-1,],LFull[-1,], HFull[-1,])
RankFull$Model <- factor(c(rep("Single Point Process", dim(Full)[1]-1),
                           rep("LRR", dim(LFull)[1]-1),
                           rep("HRR", dim(HFull)[1]-1)),
                         levels=c("Single Point Process", "LRR", "HRR"))
#order the variable levels
RankFull <- within(RankFull,
                   Variable <- factor(Variable, 
                                      levels = c("popLog10", "spRich","RFsqrt","tempMean","NDVIScale", "tempScale","primProp",
                                                  "RFScale","fireDenSqrt","NDVI", "fireDenScale")))

#RankFull$varImp <- as.numeric(as.character(RankFull$varImp))
#variable names
niceNames <- c("popLog10"="Population",
               "spRich" = "NHP Richness",
               "RFsqrt" = "Mean Rainfall",
               "tempMean" = "Mean Temperature",
               "NDVIScale" = "Scaled NDVI",
               "tempScale" = "Scaled Mean Temperature",
               "primProp" = "NHP Agriculture Overlap",
               "RFScale" = "Scaled Mean Rainfall",
               "fireDenScale" = "Scaled Fire Density",
               "NDVI" ="NDVI",
               "fireDenSqrt" ="Fire Density")

#Relative Imp Plots

b <-   ggplot(RankFull, aes(x=Variable, y=mean.Delta.AUC,ymin=mean.Delta.AUC-sem.Delta.AUC, ymax=mean.Delta.AUC+sem.Delta.AUC, fill=Model)) + 
  geom_bar(stat="identity",position="dodge")+
  geom_errorbar(position="dodge", colour="black")+
  ylab("Relative Importance") + xlab("variable") +
   #scale_y_continuous(expand = c(0, 0)) +
   scale_x_discrete("",labels=niceNames) +
  theme_few()+
  theme(axis.text.x=element_text(angle=35, hjust=1), legend.position = c(.8,.8) ) +
  scale_fill_tableau("colorblind10")

pdf("figures/manuscript/VarImp.pdf")
plot(b)
dev.off()

#latice alternative
#b2 <- 
  ggplot(RankFull, aes(x=Variable, y=mean.Delta.AUC, fill=Model)) + 
  geom_bar(stat="identity")+
  facet_grid(Model~.)+
  geom_errorbar(aes(ymin=mean.Delta.AUC-2*sem.Delta.AUC, ymax=mean.Delta.AUC+2*sem.Delta.AUC), width=.2, colour="black")+
  ylab("Relative Importance") + xlab("variable") +
   #scale_y_continuous(expand = c(0, 0)) +
   scale_x_discrete("",labels=niceNames) +
  theme_few()+
  theme(axis.text.x=element_text(angle=35, hjust=1), legend.position = c(.8,.8) ) +
  scale_fill_tableau("colorblind10")
  
  pdf("figures/manuscript/VarImpLattice.pdf")
plot(b2)
dev.off()
```


# Figure 2: Coord Plot of Variable Importance Rank Median

Ordered based on medians calculated in figure 1. Must run figure 1 for data prep.  


```{r mean coord plot data prep, eval=FALSE}

# Dodged Variable Importance ----

#1. load packages and functions

#Return Rank Importance
RankImp=function(x){
  #pull out Relative Importance
  RI <- x[[1]]
  #convert varImp to numeric (coming out as factor for some reason)
  RI$varImp <- as.numeric(as.character(RI$varImp))
  #order and add rank
  RI <- RI %>%
    dplyr::arrange(desc(varImp)) %>%
    dplyr::mutate(varRank=dim(RI)[1]:1)
  
  return(RI)
}


#2. Load data
fullM <- readRDS("../data_out/MS_results/OneModel/Perm100FullModel500TryCatch.rds") 
lowM <- readRDS("../data_out/MS_results/LowModel/lPerm100Model500TryCatch.rds")
highM <- readRDS('../data_out/MS_results/HighModel/HPerm100Model500TryCatch.rds')

#3. Pull out variable importance from permutations
Full <- RankImp(fullM)
HFull <- RankImp(highM)
LFull <- RankImp(lowM)

RankFull <- rbind(Full,LFull, HFull)
RankFull$Model <- factor(c(rep("Single Point Process", dim(Full)[1]),
                           rep("LRR", dim(LFull)[1]),
                           rep("HRR", dim(HFull)[1])),
                         levels=c("Single Point Process", "LRR", "HRR"))
```

```{r Coord Plot}
# pull out columns of interest
allRank<- allRelImportance %>% select(Model,Variable,Rank )
#flip order variable 
allRank <- within(allRank,
                   Variable <- factor(Variable, 
                                      levels = c( "fireDenScale","NDVI", "fireDenSqrt","RFScale","primProp", "tempScale","NDVIScale","tempMean", "RFsqrt","spRich", "popLog10" )))


justNamesStart <- c("Population",
               "NHP Richness",
               "Mean Rainfall",
               "Mean Temperature",
                "Scaled NDVI",
               "Scaled Mean\nTemperature",
               "NHP Agriculture\nOverlap",
               "Scaled Mean\nRainfall",
                "Fire\nDensity",
               "NDVI",
               "Scaled Fire Density") 

justNamesEnd <- c(
               "NHP Richness",
               "Population",
               "Mean Temperature",
               "NHP Agriculture\nOverlap",
               "Scaled NDVI",
               "Mean Rainfall",
               "Scaled Mean\nTemperature",
               "Fire\nDensity",
               "NDVI",
               "Scaled Mean\nRainfall",
               "Scaled Fire Density") 

y_levels <- levels(allRelImportance$Variable)

p <- ggplot(allRelImportance, aes(x = Model, y = Rank, group = Variable)) +   # group = id is important!
  geom_hline(yintercept = c(1:11), color="grey70", linetype=2, alpha=0.5, size=0.25) +
  geom_path(aes(color = Variable),lineend = 'round', linejoin = 'round', size=2) +
  scale_y_discrete(limits = levels(allRelImportance$Variable), labels=c(11:1)) + #ylim/lab details
  ylab("Variable Importance Rank (median) ") +
  xlab("Model")+
  theme_few() +
  scale_x_discrete(expand = c(0, 1)) +
  annotate("text", x = c(0.5), y=c(11:1), label = justNamesStart) + 
  annotate("text", x = c(3.5), y=c(11:1), label = justNamesEnd) + 

    theme(legend.position = "none") 

#tiff("figures/manuscript/Rank.tiff")
pdf("figures/manuscript/RankMedian.pdf")
plot(p)
dev.off()
```

#Figure 3: Maps of Calendar Months

This map is a 3 x 2 lattice, showing three characteristic annual time points in the year (represented as mean across all instances of that month) across the single and dual-process model. These values are represented by percentiles of each individual model.

## Load Data

```{r}
braz.map <- st_read("../data_clean/shapefiles", "BRAZNoIslands")
braz.map <- rename(braz.map, muni.no = muni_no)

# NHP split index
nhp.split <- readRDS("../data_clean/environmental/twoModelSplit.rds")
nhp.split.map <- left_join(braz.map, nhp.split, by = "muni.no") %>%
  group_by(above5split) %>%
  summarize() %>%
  #gets out any weird lines between polygons
  st_buffer(0.01)

#get brazil outline
braz.outline <- st_read("../data_clean/shapefiles", "brazilOutline")
braz.outline <- select(braz.outline, ADMIN)

#get other neighboring countries
s.america <- st_read("../data_clean/shapefiles", "South_America")

# prediction data
pred.one.model <- readRDS("../data_out/MS_results/OneModel/wholePredictions.rds")
pred.highNHP <- readRDS("../data_out/MS_results/HighModel/wholePredictions.rds")
pred.lowNHP <- readRDS("../data_out/MS_results/LowModel/wholePredictions.rds")
```

## Calculate Data for Plots

Rescale raw outputs into percentiles and combine into one dataframe

```{r}
pred.lowNHP <- pred.lowNHP %>%
  mutate(percentile = cut(prediction, 
                          quantile(prediction, probs = seq(0,1, by = 0.0001)), 
                          include.lowest = T,
                          labels = F)) %>%
  mutate(model = "two.model")

pred.highNHP <- pred.highNHP %>%
  mutate(percentile = cut(prediction, 
                          quantile(prediction, probs = seq(0,1, by = 0.0001)), 
                          include.lowest = T,
                          labels = F)) %>%
  mutate(model = "two.model")

pred.one.model <- pred.one.model %>%
  mutate(percentile = cut(prediction, 
                          quantile(prediction, probs = seq(0,1, by = 0.0001)), 
                          include.lowest = T,
                          labels = F)) %>%
  mutate(model = "one.model")

pred.all <- rbind(pred.lowNHP, pred.highNHP, pred.one.model) %>%
  mutate(cal.month = month.no %% 12)

pred.all$cal.month[pred.all$cal.month==0] <- 12

# pred.all.month <- pred.all %>%
#   group_by(muni.no, model, cal.month) %>%
#   summarise(mean.prob = mean(prob)) %>%
#   mutate(log.prob = log(mean.prob))

pred.all.2008 <- pred.all %>%
  mutate(year = 2001 + month.no %/% 12) %>%
  filter(year==2008)

#save probabilities
# saveRDS(pred.all, "../data_out/MS_results/probabilities.rds")

#pred.map <- left_join(pred.all.month, braz.map, by = "muni.no")

pred.map <- left_join(pred.all.2008, braz.map, by = "muni.no")

```


## Plot

```{r static map theme}
my_theme_map <- function(...) {
  theme_bw() +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.position = "right",
    plot.background = element_rect(fill = NA, color = NA), 
    panel.background = element_rect(fill = NA, color = NA), 
    panel.border = element_rect(fill = NA, color = "black"),
    legend.background = element_rect(fill = NA, color = NA),
    strip.background = element_rect(fill = NA, color = NA),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.spacing = unit(10, "pt"),
    ...
  )
}
```

```{r plot all months, eval = F}
for (k in unique(pred.map$model)){
  
  for(i in 1:12){
    
    pdf(file = paste0("figures/Fig4/", gsub("\\.", "", k), "Month", i, ".pdf"), width = 12, height = 12, family = "sans")

    p <- ggplot(data = pred.map[pred.map$cal.month == i & pred.map$model == k,])+
      geom_sf(aes(fill = mean.pred), color = NA) +
      ggtitle(paste(k, "month", i, sep = " "))
    
    print(p)

    dev.off()

  } #month loop

} #model loop
```

Subset out months we want.

```{r}
pred.map.subset <- pred.map %>%
  filter(cal.month %in% c(1,6,9)) %>%
  mutate(monthLabel = factor(month.abb[cal.month], levels = c("Jan", "Jun", "Sep")))
```

Plot.

```{r}
pdf(file = "figures/manuscript/Figure3Perc.pdf", width = 6.69, height = 4.75, family = "sans")

ggplot() +
  geom_sf(data = s.america, color = "gray80", fill = "gray80") +
  geom_sf(data = pred.map.subset, aes(fill = percentile/100), color = NA, size = 0) +
  scale_fill_distiller(palette = "OrRd", direction = 1, type = "seq",
                     guide = guide_colorbar(
                       title = "Percentile",
                       direction = "vertical",
                       title.position = 'top',
                       title.theme = element_text(size = 8, angle = 0),
                       label.theme = element_text(size = 8, angle = 0))) +
  facet_grid(model ~ monthLabel, 
             labeller = labeller(
               model = c("one.model" = 'Single', "two.model" = 'Two Part')
             )) +
  geom_sf(data = nhp.split.map, fill = NA, color = "black", size=0.1) +
  coord_sf(xlim = c(-74, -34.78), ylim = c(-33.8, 5.3), datum = NA) +
  my_theme_map()

dev.off()
```

Caption: Probability of yf spillover averaged over calendar month for December (a,d), February (b,e), and June (c,f). Result from single model in top row and two process model in bottom row.

Plot Quantile.

```{r}
pdf(file = "figures/manuscript/Figure3Quant2008.pdf", width = 6.69, height = 4.75, family = "sans")

ggplot() +
  geom_sf(data = s.america, color = "gray80", fill = "gray80") +
  geom_sf(data = pred.map.subset, aes(fill = cut(prediction, quantile(prediction, probs = seq(0,1,0.2)))), color = NA, size = 0) +
  scale_fill_brewer(palette = "OrRd", direction = 1, type = "seq",
                     guide = guide_legend(
                       title = "Ranked Quintiles",
                       direction = "horizontal",
                       title.position = 'top',
                       title.theme = element_text(size = 8, angle = 0),
                       label.theme = element_text(size = 8, angle = 0),
                       nrow = 1),
                    labels = c("0-20%", "21-40%", "41-60%", "61-80%", "81-100%")) +
  facet_grid(model ~ monthLabel, 
             labeller = labeller(
               model = c("one.model" = 'Single', "two.model" = 'Two Part')
             )) +
  geom_sf(data = nhp.split.map, fill = NA, color = "gray20", size=0.01) +
  coord_sf(xlim = c(-74, -34.78), ylim = c(-33.8, 5.3), datum = NA) +
  my_theme_map() +
  theme(legend.position = "bottom")

dev.off()
```

# Figure 4: Lattice Plot 

Figure showing results collapsed over space and time in a lattice. 

## Load Data
```{r}
# spatial data
braz.map <- st_read("../data_clean/shapefiles", "BRAZNoIslands")
braz.map <- rename(braz.map, muni.no = muni_no)

#get brazil outline
braz.outline <- getData('GADM', country ='BRA', level = 0)
braz.outline <- dplyr::select(st_as_sf(braz.outline), ISO)

#get other neighboring countries
s.america <- st_read("../data_clean/shapefiles", "South_America")

# prediction data
pred.one.model <- readRDS("../data_out/MS_results/OneModel/wholePredictions.rds")
pred.highNHP <- readRDS("../data_out/MS_results/HighModel/wholePredictions.rds")
pred.lowNHP <- readRDS("../data_out/MS_results/LowModel/wholePredictions.rds")

```

## Calculate Values

### Over Space

This calculates the variance per municipality to get a measure of "flickering". The variance is calculated on the raw values.

```{r}
# calculate variance per municipality over whole time period
var.one.model <- as.data.frame(pred.one.model) %>%
  group_by(muni.no) %>%
  summarise(pred.var = var(prediction)) %>%
  mutate(model = "one.model")

var.highNHP <- as.data.frame(pred.highNHP) %>%
  group_by(muni.no) %>%
  summarise(pred.var = var(prediction)) %>%
  mutate(model = "highNHP")

var.lowNHP <- as.data.frame(pred.lowNHP) %>%
  group_by(muni.no) %>%
  summarise(pred.var = var(prediction)) %>%
  mutate(model = "lowNHP")

var.all.models <- rbind(var.one.model, var.highNHP, var.lowNHP) %>%
  left_join(braz.map, by = "muni.no")

rm(var.one.model, var.highNHP, var.lowNHP)

var.all.models$model <- factor(var.all.models$model, levels = c("one.model", "lowNHP", "highNHP"))
```


### Over Time

This looks at a time series, averaged over all municipalities by month. This is also plotting the raw outputs.

```{r}
time.one.model <- as.data.frame(pred.one.model) %>%
  group_by(month.no) %>%
  summarise(pred.mean = mean(prediction, na.rm = T)) %>%
  mutate(model = "one.model")

time.lowNHP <- as.data.frame(pred.lowNHP) %>%
  group_by(month.no) %>%
  summarise(pred.mean = mean(prediction, na.rm = T)) %>%
  mutate(model = "lowNHP")

time.highNHP <- as.data.frame(pred.highNHP) %>%
  group_by(month.no) %>%
  summarise(pred.mean = mean(prediction, na.rm = T)) %>%
  mutate(model = "highNHP")

time.all.models <- rbind(time.one.model, time.highNHP, time.lowNHP) 

#create cal.month variable (1 - 12)
time.all.models <- time.all.models %>%
  mutate(cal.month = month.no %% 12)

time.all.models$cal.month[time.all.models$cal.month==0] <- 12

#create year variable
time.all.models <- time.all.models %>%
  mutate(year = ((month.no-1) %/% 12) + 2001) %>%
  mutate(monthLabel = lubridate::month(cal.month, label = T))

#order models
time.all.models$model <- factor(time.all.models$model, levels = c("one.model", "lowNHP", "highNHP"))

rm(time.one.model, time.highNHP, time.lowNHP)
```

## Plot

### Over Space

```{r map theme}
my_theme_map <- function(...) {
  theme_minimal() +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.position = "left",
    panel.grid = element_blank(),
    plot.background = element_rect(fill = NA, color = NA), 
    panel.background = element_rect(fill = NA, color = NA), 
    panel.border = element_rect(fill = NA, color = "black"),
    legend.background = element_rect(fill = NA, color = NA),
    strip.background = element_blank(),
    strip.text = element_blank(),
    plot.margin = unit(c(0,5,0,5), unit = "pt"),
    ...
  )
}
```


```{r facet}
top.row <- ggplot() +
    geom_sf(data = s.america, color = "gray80", fill = "gray80") +
    geom_sf(data = braz.outline, color = "gray25", size = 0.1) +
    geom_sf(data = var.all.models, aes(fill = pred.var), color = NA) +
    scale_fill_viridis(option = "magma", direction = -1, discrete = F,
                     na.value = "gray70", 
                     guide = guide_colorbar(
                       title = "Variance",
                       direction = "vertical",
                       barheight = unit(35, units = "mm"),
                       barwidth = unit(2, units = "mm"),
                       draw.ulim = F,
                       title.position = 'top',
                       # some shifting around
                       title.hjust = 0.5,
                       label.hjust = 0.5,
                       title.theme = element_text(size = 8, angle = 0),
                       label.theme = element_text(size = 8, angle = 0))) +
  my_theme_map() +
  facet_wrap(~model, dir = "h") +
  coord_sf(xlim = c(-74, -34.78), ylim = c(-33.8, 5.3), datum = NA)
```


### Over Time

We plot a line for each year, with a detrended loess line in a darker color.

```{r try a facet}
bottom.row <-  ggplot(data = time.all.models, aes(x = monthLabel, y = pred.mean)) +
    geom_line(aes(group = year), color = "gray70")+
    geom_smooth(aes(x = cal.month, y = pred.mean), se = F, color = "black") +
    theme_minimal() +
    ylab("Mean Prediction") +
    xlab("") +
    scale_x_discrete(breaks = c("Jan","Mar","May","Jul","Sep","Nov")) +
    theme(
      axis.title = element_text(size = 12),
      axis.text = element_text(size = 10),
      axis.text.x = element_text(size = 10, angle = 90, 
                                 vjust=0.2, hjust = 0),
      panel.background = element_blank(),
      strip.background = element_blank(),
      strip.text.x = element_blank(),
      axis.line = element_line(),
      panel.grid = element_blank(),
      axis.line.y = element_line(),
      axis.ticks.length = unit(0.5, "lines"),
      axis.ticks = element_line()
    ) +
  facet_wrap(~model) +
  panel_border()
```

## Combine into one lattice plot

Use cowplot. Note sometimes you need to make sure any pdf devices are off by running `dev.off()` a whole bunch of times first.

```{r}
pdf(file = "figures/manuscript/Figure4.pdf", width = 6.69, height = 4.75, family = "sans")

ggdraw() +
  draw_plot(top.row, x = 0, y = 0.5, width = 1, height = 0.5) +
  draw_plot(bottom.row, x = 0.02, y = 0, width = 0.98, height = 0.5) +
  draw_plot_label(label = letters[1:6],
                  x = c(0.1,0.4,0.70,0.1,0.4,0.70),
                  y = c(1,1,1,0.53,0.53,0.53), 
                  size = 12)

dev.off()
```

**Caption:** Model variance through space (a,b,c) and time(d,e,f). Plots of variance municipality-level predictions using the single process model (a), dual process model with low reservoir richness (b), and dual process model with high reservoir richness (c). Mean probability across the entire study area of Brazil for the single process model (e), dual process model with low reservoir richness (e), and dual process model with high reservoir richness (f). Gray lines represent an individual year of data with overall mean in black.


# Supp. Figure X: Gif of maps

This will be a big gif with a panel for each model. Each will have a different color scheme (like green, blue,red, etc.) so it is clear they are not meant to be compared. It will be a plot of raw predictions.

```{r}

```


---
title: "Manuscript Figures"
author: ""
date: "January 23, 2018"
output: html_document
---

# Packages and Set-Up

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)

#fig 3
library(sf)
library(raster)
library(viridis)
library(cowplot)
```

This document creates the figures for:

*Insert manuscript citation here*

I'm currently loading data individually for each figure, then if you want to remake one figure you don't have to rerun the whole document, just that section.

# Figure 1: ROC Plots

# Figure 2: Variable Importance

Dodged barplot of variable importance

# Figure 3: Lattice Plot 

Figure showing results collapsed over space and time in a lattice. Maybe want to focus on showing variation via sd?

## Load Data
```{r}
# spatial data
braz.map <- st_read("../data_clean", "BRAZpolygons")
braz.map <- rename(braz.map, muni.no = muni_no)

#get brazil outline
braz.outline <- getData('GADM', country ='BRA', level = 0)
braz.outline <- st_as_sf(braz.outline)
braz.outline <- dplyr::select(braz.outline , id = OBJECTID, ID_0, ISO)

# prediction data
pred.one.model <- readRDS("../data_out/Predictions/SpaceAndTime/Trim2014/fullPredictions.rds")
predTwoModel <- load("../data_out/Predictions/TwoModel/Trim2014/fullPredictions.RData")
pred.highNHP <- hPredFull
pred.lowNHP <- lPredFull

rm(lPredFull, hPredFull, predTwoModel)
```

## Calculate Values

### Over Space

I'm calculating the variation per municipality to get a measure of "flickering".

```{r}
# calculate variation per municipality over whole time period
var.one.model <- as.data.frame(pred.one.model) %>%
  group_by(muni.no) %>%
  summarise(pred.var = var(prediction, na.rm = T)) %>%
  mutate(model = "one.model")

var.highNHP <- as.data.frame(pred.highNHP) %>%
  group_by(muni.no) %>%
  summarise(pred.var = var(prediction, na.rm = T)) %>%
  mutate(model = "highNHP")

var.lowNHP <- as.data.frame(pred.lowNHP) %>%
  group_by(muni.no) %>%
  summarise(pred.var = var(prediction, na.rm = T)) %>%
  mutate(model = "lowNHP")

var.all.models <- rbind(var.one.model, var.highNHP, var.lowNHP) %>%
  left_join(braz.map, by = "muni.no")
```


### Over Time

We want a time series, averaged across all municipalities per month.

This takes the mean

```{r}
time.one.model <- as.data.frame(pred.one.model) %>%
  group_by(month.no) %>%
  summarise(pred.mean = mean(prediction, na.rm = T),
            pred.median = median(prediction, na.rm = T),
            pred.sd = sd(prediction, na.rm = T), 
            #calculate quantiles for confident intervals
            pred.05 = quantile(prediction, 0.05),
            pred.95 = quantile(prediction, 0.95)) %>%
    mutate(model = "one.model")

time.lowNHP <- as.data.frame(pred.lowNHP) %>%
  group_by(month.no) %>%
  summarise(pred.mean = mean(prediction, na.rm = T), 
            pred.sd = sd(prediction, na.rm = T), 
            pred.median = median(prediction, na.rm = T),
            #calculate quantiles for confident intervals
            pred.05 = quantile(prediction, 0.05),
            pred.95 = quantile(prediction, 0.95)) %>%
    mutate(model = "lowNHP")

time.highNHP <- as.data.frame(pred.highNHP) %>%
  group_by(month.no) %>%
  summarise(pred.mean = mean(prediction, na.rm = T), 
            pred.median = median(prediction, na.rm = T),
            pred.sd = sd(prediction, na.rm = T), 
            #calculate quantiles for confident intervals
            pred.05 = quantile(prediction, 0.05),
            pred.95 = quantile(prediction, 0.95)) %>%
    mutate(model = "highNHP")

time.all.models <- rbind(time.one.model, time.highNHP, time.lowNHP) 

#create cal.month variable (1 - 12)
time.all.models <- time.all.models %>%
  mutate(cal.month = month.no %% 12)

time.all.models$cal.month[time.all.models$cal.month==0] <- 12

#create year variable
time.all.models <- time.all.models %>%
  mutate(year = ((month.no-1) %/% 12) + 2001)
```

## Plot

### Over Space

```{r map theme}
theme_map <- function(...) {
  theme_minimal() +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    # panel.grid.minor = element_line(color = "#ebebe5", size = 0.2),
    # panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "#f5f5f2", color = NA), 
    panel.background = element_rect(fill = "#f5f5f2", color = NA), 
    legend.background = element_rect(fill = "#f5f5f2", color = NA),
    panel.border = element_blank(),
    ...
  )
}
```

```{r space plot faceted}
space.plot <- ggplot() +
  geom_sf(data = braz.outline, color = "gray25", size = 0.1) +
  geom_sf(data = var.all.models, aes(fill = pred.var), color = NA) +
  coord_sf()+
    scale_fill_viridis(option = "magma", direction = -1, discrete = F,
                     na.value = "gray70", 
                     guide = guide_colorbar(
                       direction = "horizontal",
                       barheight = unit(2, units = "mm"),
                       barwidth = unit(50, units = "mm"),
                       draw.ulim = F,
                       title.position = 'top',
                       # some shifting around
                       title.hjust = 0.5,
                       label.hjust = 0.5),
                     limits = c(0,0.07)) +
  theme_map() +
  facet_wrap(~model, dir = "h")

space.plot
```

### Over Time

We can plot it in facets (ie one plot per model).

```{r}
ggplot(data = time.all.models)+
  #95% quantiles
  #geom_ribbon(aes(x = month.no, ymin = pred.05, ymax = pred.95))+
  #sd
  geom_ribbon(aes(x = month.no, 
                  ymin = pred.mean - pred.sd, 
                  ymax = pred.mean + pred.sd), 
              fill = "gray90")+
  geom_line(aes(x = month.no, y = pred.mean, color = model))+
  #geom_line(aes(x = month.no, y =pred.median), color = "blue") +
  facet_wrap(~model) +
  theme_minimal()
```

Also can plot all on one plot. I don't think this is as visually stunning, but I think it does demonstrate how different the the highNHP is from the other two models. In many instances overall "risk" is going down in the one.model and low NHP, and going up in the high NHP.

```{r}
ggplot(data = time.all.models)+
  geom_line(aes(x = month.no, y = pred.mean, color = model))+
  theme_minimal()
```

We could also plot by month:

```{r}
ggplot(data = time.all.models, aes(group = cal.month))+
  geom_boxplot(aes(x=cal.month, y = pred.mean)) +
  #geom_point(aes(x = jitter(cal.month), y = pred.mean))+
  facet_wrap(~model)
```

Actually, plotting the seasonality by month may be most effective. Boxplots are dumb, but this gets our point across. Alternatively, we could plot each year and then add a smoothed line (i.e. detrending for each year):

#### Michelle's Current Fav
```{r}
time.plot <- ggplot(data = time.all.models, aes(x=cal.month, y = pred.mean))+
  geom_line(aes(group = year), color = "gray70")+
  geom_smooth(se = F)+
  facet_wrap(~model) +
  theme_bw()

time.plot
```

Would also be cool to add those frequency dots to the bottom showing positive cases.

## Combine into one lattice plot

I may have to actually create each plot seperately, instead of facetting them, to do this.

#Figure 4: Maps

Choose maps at certain time points to represent spatial patterns.

Don't know which time points as of yet. This will pair with the supplementary gif.

# Supp. Figure X: Gif of maps

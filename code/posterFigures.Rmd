---
title: "Poster Figures"
author: "Michelle Evans"
date: "2/19/2018"
output: html_document
---

This document makes figures from the yellow fever Brazil project for a poster.

Poster Session:

Symposium on Vector Population Dynamics. Feb 2018. University of Georgia. Center for Ecology of Infectious Diseases.

# Packages and Set-Up

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sf)
library(RColorBrewer)
library(ggthemes)
library(lubridate)
library(ggplot2)
library(reshape2)
```

Set Up colors

```{r}
singleCol <- "#1b9e77"
lrrCol <- "#d95f02"
hrrCol <- "#7570b3"
```



# Seasonality of three models

This plot shows the difference in seasonality by taking the average risk across space by year.

## Data

Load data.
```{r}
# prediction data
pred.one.model <- readRDS("../data_out/MS_results_revisions/Infection/OneModel/wholePredictions.rds")
pred.highNHP <- readRDS("../data_out/MS_results_revisions/Infection/HighModel/wholePredictions.rds")
pred.lowNHP <- readRDS("../data_out/MS_results_revisions/Infection/LowModel/wholePredictions.rds")

nhp.split <- readRDS("../data_clean/environmental/twoModelSplit.rds")
```

Calculate seasonality (mean for all of brazil by month by model)

```{r}
time.one.model <- as.data.frame(pred.one.model) %>%
  left_join(nhp.split, by = "muni.no") %>%
  mutate(region = case_when(
    above5split == "above5" ~ "HRR",
    above5split == "less" ~ "LRR"
  )) %>%
  group_by(month.no, region) %>%
  summarise(pred.mean = mean(prediction, na.rm = T), sumCases = sum(case)) %>%
  mutate(model = "one.model") %>%
  select(month.no, pred.mean, sumCases, model, region) %>%
  ungroup()

time.lowNHP <- as.data.frame(pred.lowNHP) %>%
  group_by(month.no) %>%
  summarise(pred.mean = mean(prediction, na.rm = T), sumCases = sum(case)) %>%
  mutate(model = "two.model") %>%
  mutate(region = "LRR")

time.highNHP <- as.data.frame(pred.highNHP) %>%
  group_by(month.no) %>%
  summarise(pred.mean = mean(prediction, na.rm = T), sumCases = sum(case)) %>%
  mutate(model = "two.model") %>%
  mutate(region = "HRR")

time.all.models <- rbind(time.one.model, time.highNHP, time.lowNHP) 

#create cal.month variable (1 - 12)
time.all.models <- time.all.models %>%
  mutate(cal.month = month.no %% 12)

time.all.models$cal.month[time.all.models$cal.month==0] <- 12

#create year variable
time.all.models <- time.all.models %>%
  mutate(year = ((month.no-1) %/% 12) + 2001) %>%
  mutate(monthLabel = lubridate::month(cal.month, label = T))

#order models
time.all.models$model <- factor(time.all.models$model, 
                                levels = c("one.model", "two.model"))
time.all.models$region <- factor(time.all.models$region, 
                                 levels = c("LRR", "HRR"))

rm(time.one.model, time.highNHP, time.lowNHP)
```

##Plot

```{r}
png(file = "../data_out/MS_results_revisions/Infection/figures/poster-seasonality.png", width = 2000, height = 2000, units = "px", res = 300, bg = NA)

ggplot(data = time.all.models, aes(x = monthLabel, y = pred.mean)) +
    geom_line(aes(group = year), color = "gray70", size = 1)+
    geom_smooth(aes(x = cal.month, y = pred.mean), se = F, color = "black", 
                size = 1.5) +
    theme_bw() +
    ylab("") +
    xlab("") +
    scale_x_discrete(breaks = c("Jan","Mar","May","Jul","Sep","Nov")) +
    theme(
      axis.title = element_text(size = 40),
      axis.text = element_text(size = 20),
      axis.text.x = element_text(size = 20, angle = 60, 
                                 vjust=1, hjust = 1),
      panel.background = element_blank(),
      strip.background = element_blank(),
      strip.text = element_blank(),
      axis.line = element_line(),
      panel.grid = element_blank(),
      axis.line.y = element_line(),
      axis.ticks.length = unit(0.5, "lines"),
      axis.ticks = element_line()
    ) +
  facet_grid(region~model) +
  geom_rug(aes(x=jitter(as.numeric(monthLabel),0.2), alpha = sumCases^0.5, size = sumCases), inherit.aes = FALSE) +
  scale_alpha(range = c(0,1)) +
  guides(alpha = F, size = F)

dev.off()
```

## Calculate regional AUC's

```{r}
library(ROCR)

natl.low <- pred.one.model %>%
  left_join(nhp.split, by = "muni.no") %>%
  filter(above5split == "less") %>%
  filter(set == "test")

performance(prediction(natl.low$prediction, natl.low$case), measure = "auc")@y.values

natl.high <- pred.one.model %>%
  left_join(nhp.split, by = "muni.no") %>%
  filter(above5split == "above5") %>%
  filter(set == "test")

performance(prediction(natl.high$prediction, natl.high$case), measure = "auc")@y.values

performance(prediction(pred.highNHP$prediction[pred.highNHP$set == "test"], pred.highNHP$case[pred.highNHP$set == "test"]), measure = "auc")@y.values

performance(prediction(pred.lowNHP$prediction[pred.lowNHP$set == "test"], pred.lowNHP$case[pred.lowNHP$set == "test"]), measure = "auc")@y.values
```



# Variable Importance Across Models

Plot of variable importance.

## Functions

```{r}
#function to calculate dAUC stats
RelativeImportance=function(x, model="NA"){
  perms <- x[[3]][complete.cases(x[[3]]),-c(1, dim(x[[3]])[2])] # pull out AUC values, but drop full model and all permuted data columns 
  model.AUC <- as.numeric(as.character(x[[2]][1,2])) # pull out AUC for full model
  # calculate delta AUC
  delta.AUC <- model.AUC- perms
    # scale delta AUC between zero and one
    #scale.delta.AUC <- delta.AUC/max(delta.AUC)
  #calculate median, upper and lower quantiles
  Quant.dAUC <- delta.AUC %>% 
    melt(value.name="dAUC") %>% 
    rename(Rep=Var1, Variable=Var2)%>% 
    group_by(Variable) %>%
    summarise(dAUCmean=mean(dAUC),dAUCmedian=median(dAUC),Q975=quantile(dAUC, probs=0.975),Q025=quantile(dAUC, probs=0.025) ) %>%
    ungroup()
  
  scale.dAUC <- Quant.dAUC %>%
      group_by(Variable) %>%
      mutate_all(funs(./max(Quant.dAUC$Q975))) %>% # divid all values by max median value
      arrange(desc(dAUCmedian))%>%
      ungroup() %>%  
      mutate(Rank=c(11:1), Model=model)
      
  return(scale.dAUC)
}

#Return Rank Importance
RankImp <- function(x){
  #pull out Relative Importance
  RI <- x[[1]]
  #convert varImp to numeric (coming out as factor for some reason)
  RI$varImp <- as.numeric(as.character(RI$varImp))
  #order and add rank
  RI <- RI %>%
    dplyr::arrange(desc(varImp)) %>%
    dplyr::mutate(varRank=dim(RI)[1]:1)
  
  return(RI)
}
```

## Calculate Values
```{r}
#load data
fullM <- readRDS("../data_out/MS_results/OneModel/Perm100FullModel500TryCatch.rds") 
lowM <- readRDS("../data_out/MS_results/LowModel/lPerm100Model500TryCatch.rds")
highM <- readRDS('../data_out/MS_results/HighModel/HPerm100Model500TryCatch.rds')
```


```{r}
hri <- RelativeImportance(highM, "High")
lri <- RelativeImportance(lowM, "Low")
fri <- RelativeImportance(fullM, "Single")
allRelImportance<- rbind(fri,lri,hri)

#reorder factors for plotting 
allRelImportance <- within(allRelImportance, Variable <- factor(Variable, levels = c( "popLog10","spRich","RFsqrt","tempMean","NDVIScale","tempScale","primProp","RFScale","fireDenSqrt","NDVI","fireDenScale")))
allRelImportance <- within(allRelImportance, Model <- factor(Model, levels = c("Single","Low","High")))
```

Second data loading and calculations:

```{r}
#2. Load data
fullM <- readRDS("../data_out/MS_results/OneModel/Perm100FullModel500TryCatch.rds") 
lowM <- readRDS("../data_out/MS_results/LowModel/lPerm100Model500TryCatch.rds")
highM <- readRDS('../data_out/MS_results/HighModel/HPerm100Model500TryCatch.rds')

#3. Pull out variable importance from permutations
Full <- RankImp(fullM)
HFull <- RankImp(highM)
LFull <- RankImp(lowM)

RankFull <- rbind(Full,LFull, HFull)
RankFull$Model <- factor(c(rep("Single Point Process", dim(Full)[1]),
                           rep("LRR", dim(LFull)[1]),
                           rep("HRR", dim(HFull)[1])),
                         levels=c("Single Point Process", "LRR", "HRR"))

# pull out columns of interest
allRank<- allRelImportance %>% select(Model,Variable,Rank )
#flip order variable 
allRank <- within(allRank,
                   Variable <- factor(Variable, 
                                      levels = c( "fireDenScale","NDVI", "fireDenSqrt","RFScale","primProp", "tempScale","NDVIScale","tempMean", "RFsqrt","spRich", "popLog10" )))


justNamesStart <- c("Population",
               "NHP Richness",
               "Mean Rainfall",
               "Mean\nTemperature",
                "Scaled NDVI",
               "Scaled Mean\nTemperature",
               "NHP Agriculture\nOverlap",
               "Scaled Mean\nRainfall",
                "Fire\nDensity",
               "NDVI",
               "Scaled\nFire Density") 

justNamesEnd <- c(
               "NHP Richness",
               "Population",
               "Mean\nTemperature",
               "NHP Agriculture\nOverlap",
               "Scaled NDVI",
               "Mean Rainfall",
               "Scaled Mean\nTemperature",
               "Fire\nDensity",
               "NDVI",
               "Scaled Mean\nRainfall",
               "Scaled\nFire Density") 
```

## Coord Plot

```{r}
png(file = "figures/poster/coordPlot.png", width = 2100, height = 2400, units = "px", res = 300, bg = 'transparent')

ggplot(allRelImportance, aes(x = Model, y = Rank, group = Variable)) +   # group = id is important!
  geom_hline(yintercept = c(1:11), color="grey70", linetype=2, alpha=0.5, size=0.25) +
  geom_path(aes(color = Variable),lineend = 'round', linejoin = 'round', size=2) +
  scale_y_discrete(limits = levels(allRelImportance$Variable), labels=c(11:1)) + #ylim/lab details
  ylab("") +
  xlab("")+
  scale_x_discrete(expand = c(0, 1)) +
  annotate("text", x = c(0.5), y=c(11:1), label = justNamesStart, size = 5) + 
  annotate("text", x = c(3.5), y=c(11:1), label = justNamesEnd, size = 5) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank()
  ) + 
  guides(color = F) + 
  scale_color_gdocs()
  # scale_color_manual(values = c("gray40", "gray40", "firebrick3", "gray40",
  #                               "gray40", "firebrick3", "firebrick3",
  #                               "firebrick3", "gray40", "gray40", "gray40"))

dev.off()
```



## Bar Plot

```{r}
#variable names for publication
niceNames <- c("popLog10"="Population",
               "spRich" = "NHP Richness",
               "RFsqrt" = "Mean Rainfall",
               "tempMean" = "Mean Temperature",
               "NDVIScale" = "Scaled NDVI",
               "tempScale" = "Scaled Mean Temperature",
               "primProp" = "NHP Agriculture Overlap",
               "RFScale" = "Scaled Mean Rainfall",
               "fireDenScale" = "Scaled Fire Density",
               "NDVI" ="NDVI",
               "fireDenSqrt" ="Fire Density")

#reorder variables
allRelImportance <- within(allRelImportance, Variable2 <- factor(Variable, levels = c("popLog10","spRich","RFsqrt","tempMean","NDVIScale","tempScale","primProp","RFScale","fireDenSqrt","NDVI","fireDenScale")[11:1]))
```


```{r}
png(file = "figures/poster/varimpPlot.png", width = 3600, height = 2400, units = "px", res = 300, bg = 'transparent')

ggplot(allRelImportance, aes(x=Variable2, y=dAUCmedian, fill=Model)) + 
  geom_bar(stat="identity",position="dodge", alpha = 0.7)+
  ylab("") + 
  xlab("") +
  scale_x_discrete("",labels=niceNames[11:1]) +
  theme_few()+
  theme(axis.text=element_text(size=24), 
        legend.position = c(.8,.8),
        panel.border = element_blank()) +
  scale_fill_manual(values = c(singleCol, lrrCol, hrrCol)) +
  guides(fill = F) +
  coord_flip()

dev.off()
  
```



# Map of Each Model Spatial Layout

Just a simple map showing what the whole country, LRR, and HRR are referring too.

## Load shapefiles

```{r}
braz.outline <- st_read("../data_clean/shapefiles", "brazilOutline")
braz.outline <- select(braz.outline, ADMIN)

braz.map <- st_read("../data_clean/shapefiles", "BRAZNoIslands")
braz.map <- rename(braz.map, muni.no = muni_no)

# NHP split index
nhp.split <- readRDS("../data_clean/environmental/twoModelSplit.rds")
nhp.split.map <- left_join(braz.map, nhp.split, by = "muni.no") %>%
  group_by(above5split) %>%
  summarize() %>%
  #gets out any weird lines between polygons
  st_buffer(0.01)

rm(braz.map, nhp.split)
```

## Whole Country

```{r}
png(file = "figures/poster/allBrazil.png", width = 900, height = 900, units = "px", res = 300, bg = 'transparent')

ggplot(data = braz.outline) +
  geom_sf(fill = singleCol, alpha = 0.6) + 
  theme_minimal() +
  coord_sf(xlim = c(-74, -34.78), ylim = c(-33.8, 5.3), datum = NA)

dev.off()
```

##LRR

```{r}
png(file = "figures/poster/LRRmap.png", width = 900, height = 900, units = "px", res = 300, bg = 'transparent')

ggplot(data = nhp.split.map) +
  geom_sf(aes(fill = above5split), alpha = 0.6) + 
  scale_fill_manual(values = c(NA, lrrCol)) +
  theme_minimal() +
  coord_sf(xlim = c(-74, -34.78), ylim = c(-33.8, 5.3), datum = NA) +
  guides(fill = F)

dev.off()
```


##HRR

```{r}
png(file = "figures/poster/HRRmap.png", width = 900, height = 900, units = "px", res = 300, bg = 'transparent')

ggplot(data = nhp.split.map) +
  geom_sf(aes(fill = above5split), alpha = 0.6) + 
  scale_fill_manual(values = c(hrrCol, NA)) +
  theme_minimal() +
  coord_sf(xlim = c(-74, -34.78), ylim = c(-33.8, 5.3), datum = NA) +
  guides(fill = F)

dev.off()
```

# Model of example months

3 x 2 lattice showing three months and both models

## Process Data

Load Data

```{r}
braz.map <- st_read("../data_clean/shapefiles", "BRAZNoIslands")
braz.map <- rename(braz.map, muni.no = muni_no)

# NHP split index
nhp.split <- readRDS("../data_clean/environmental/twoModelSplit.rds")
nhp.split.map <- left_join(braz.map, nhp.split, by = "muni.no") %>%
  group_by(above5split) %>%
  summarize() %>%
  #gets out any weird lines between polygons
  st_buffer(0.01)

#get brazil outline
braz.outline <- st_read("../data_clean/shapefiles", "brazilOutline")
braz.outline <- select(braz.outline, ADMIN)

#get other neighboring countries
s.america <- st_read("../data_clean/shapefiles", "South_America")

# prediction data
pred.one.model <- readRDS("../data_out/MS_results/OneModel/wholePredictions.rds")
pred.highNHP <- readRDS("../data_out/MS_results/HighModel/wholePredictions.rds")
pred.lowNHP <- readRDS("../data_out/MS_results/LowModel/wholePredictions.rds")
```

Calculate Percentiles

```{r}
pred.lowNHP <- pred.lowNHP %>%
  mutate(percentile = cut(prediction, 
                          quantile(prediction, probs = seq(0,1, by = 0.0001)), 
                          include.lowest = T,
                          labels = F)) %>%
  mutate(model = "two.model")

pred.highNHP <- pred.highNHP %>%
  mutate(percentile = cut(prediction, 
                          quantile(prediction, probs = seq(0,1, by = 0.0001)), 
                          include.lowest = T,
                          labels = F)) %>%
  mutate(model = "two.model")

pred.one.model <- pred.one.model %>%
  mutate(percentile = cut(prediction, 
                          quantile(prediction, probs = seq(0,1, by = 0.0001)), 
                          include.lowest = T,
                          labels = F)) %>%
  mutate(model = "one.model")

pred.all <- rbind(pred.lowNHP, pred.highNHP, pred.one.model) %>%
  mutate(cal.month = month.no %% 12)

pred.all$cal.month[pred.all$cal.month==0] <- 12

pred.all <- mutate(pred.all, year = 2001 + month.no %/% 12)

pred.all.year <- pred.all %>%
  filter(year==2012)

pred.map.all <- left_join(pred.all, braz.map, by = "muni.no")

pred.map.year <- left_join(pred.all.year, braz.map, by = "muni.no")

pred.map.subset <- pred.map.year %>%
  filter(cal.month %in% c(1,6,9)) %>%
  mutate(monthLabel = factor(month.abb[cal.month], levels = c("Jan", "Jun", "Sep")))
```

Calculate case centroids

```{r}
case.centroids <- pred.map.all %>%
  filter(case==1)

case.centroids <- st_centroid(st_sf(case.centroids))
```


## Static Plot

Map theme

```{r}
my_theme_map <- function(...) {
  theme_bw() +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.position = "right",
    plot.background = element_rect(fill = NA, color = NA), 
    panel.background = element_rect(fill = NA, color = NA), 
    panel.border = element_rect(fill = NA, color = "black"),
    legend.background = element_rect(fill = NA, color = NA),
    strip.background = element_rect(fill = NA, color = NA),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.spacing = unit(10, "pt"),
    ...
  )
}
```


```{r}
png(file = "figures/poster/staticMap.png", width = 2700, height = 1800, units = "px", res = 300, bg = 'transparent')

ggplot() +
  geom_sf(data = s.america, color = "gray80", fill = "gray80") +
  geom_sf(data = pred.map.subset, aes(fill = percentile/100), color = NA, size = 0) +
  scale_fill_distiller(palette = "OrRd", direction = 1, type = "seq",
                     guide = guide_colorbar(
                       title = "Percentile",
                       direction = "vertical",
                       title.position = 'top',
                       title.theme = element_text(size = 8, angle = 0),
                       label.theme = element_text(size = 8, angle = 0))) +
  facet_grid(model ~ monthLabel, 
             labeller = labeller(
               model = c("one.model" = 'Single', "two.model" = 'Two Part')
             )) +
  geom_sf(data = nhp.split.map, fill = NA, color = "black", size=0.1) +
  coord_sf(xlim = c(-74, -34.78), ylim = c(-33.8, 5.3), datum = NA) +
  my_theme_map()

dev.off()
```


## GIFs

Make individual png file and then loop together using Image Magick afterwards.

```{r} 
for (i in 1:max(pred.map.all$month.no)){
  
  png(file = paste0("figures/poster/gifs/month", 
                    formatC(i, width = 3, format = "d", flag = "0"), ".png"), 
      width = 1800, height = 1000, units = "px", res = 300, bg = 'white')
  #adjust for my bad ability at division which makes december respond strange
  if (i%%12 == 0){
    plot.year <- 2000 + (i%/% 12)
    plot.month <- "December"
  } else{
    plot.year <- 2001 + (i%/% 12)
    plot.month <- month.name[i %% 12]
  }
  
  plotTitle <- paste("Spillover risk in", plot.month, plot.year, sep = " ")
  
gif.plot <- ggplot() +
  geom_sf(data = s.america, color = "gray80", fill = "gray80") +
  geom_sf(data = pred.map.all[pred.map.all$month.no==i,], aes(fill = percentile/100), color = NA, size = 0) +
  scale_fill_distiller(palette = "OrRd", direction = 1, type = "seq", limits = c(0,100),
                     guide = guide_colorbar(
                       title = "Percentile",
                       direction = "vertical",
                       title.position = 'top',
                       title.theme = element_text(size = 8, angle = 0),
                       label.theme = element_text(size = 8, angle = 0))
                     ) +
  facet_grid(. ~ model, 
             labeller = labeller(
               model = c("one.model" = 'Country-wide', "two.model" = 'Regional')
             )) +
  geom_sf(data = nhp.split.map, fill = NA, color = "black", size=0.1) +
  geom_sf(data = case.centroids[case.centroids$month.no==i,], size = 1) + 
  coord_sf(xlim = c(-74, -34.78), ylim = c(-33.8, 5.3), datum = NA) +
  my_theme_map() +
  ggtitle(plotTitle)

print(gif.plot)

dev.off()

}
```

Use ImageMagick to create plot from png files

cd into `figures/poster/gifs`
CMDLINE: `convert -delay 50 *.png \MapPercentile.gif`